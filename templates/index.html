<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance System - Smart Recognition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @keyframes scan-line {
        0% { transform: translateY(-10%); }
        100% { transform: translateY(100%); }
      }
      .scanner-line {
        animation: scan-line 2.5s ease-in-out infinite;
      }
    </style>
  </head>
  <body class="bg-white text-black min-h-screen font-sans">
    <!-- Navigation -->
    <nav class="bg-white/80 backdrop-blur-md border-b border-gray-200 z-50 sticky top-0">
      <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
          <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-black text-white rounded-lg flex items-center justify-center">
              <span class="text-2xl">ðŸ“‹</span>
            </div>
            <span class="font-bold text-xl">Attendance AI</span>
          </div>
          <div class="flex items-center space-x-4">
            {% if model_loaded %}
            <span class="px-3 py-1 bg-green-100 border border-green-300 text-green-800 rounded-full text-sm font-medium">Model Ready</span>
            {% else %}
            <span class="px-3 py-1 bg-red-100 border border-red-300 text-red-800 rounded-full text-sm font-medium">Model Not Loaded</span>
            {% endif %}
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content Wrapper -->
    <div id="mainContentWrapper">
      <div class="max-w-3xl mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-5xl font-bold mb-4">Automated Attendance Recognition</h1>
          <p class="text-gray-600 text-lg max-w-2xl mx-auto">Upload your attendance sheet to get started.</p>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="mb-8 space-y-4">
            {% for category, message in messages %}
              {% if category == 'success' %}
              <div class="bg-green-50 border border-green-200 text-green-800 px-6 py-4 rounded-lg flex items-start space-x-3">
                <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div><p class="font-semibold">Success!</p><p class="text-sm">{{ message }}</p></div>
              </div>
              {% else %}
              <div class="bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg flex items-start space-x-3">
                <svg class="w-6 h-6 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <div><p class="font-semibold">Error</p><p class="text-sm">{{ message }}</p></div>
              </div>
              {% endif %}
            {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <!-- Main Card -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
          <div class="p-8">
            <div>
              <h2 class="text-2xl font-bold flex items-center space-x-2 mb-2"><span>Upload Attendance Sheet</span></h2>
              <p class="text-gray-500 mb-6">Supports PNG, JPG, JPEG formats (Max 16MB)</p>
              <form method="POST" enctype="multipart/form-data" id="uploadForm">
                <div id="uploadArea" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-black transition-all duration-300 cursor-pointer relative">
                  <input type="file" name="file" id="fileInput" accept="image/*" required class="hidden"/>
                  <div id="uploadContent">
                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <h3 class="text-lg font-semibold text-black mb-1">Drop your image here or click</h3>
                    <p class="text-gray-500 text-sm">Select a file from your device</p>
                  </div>
                  <div id="imagePreviewContainer" class="hidden absolute inset-0 p-2">
                    <img id="imagePreview" class="w-full h-full object-contain rounded-md" />
                    <div id="scanner" class="hidden absolute inset-0 w-full h-full overflow-hidden rounded-md">
                      <div class="scanner-line absolute top-0 w-full h-1 bg-blue-500/50 shadow-lg shadow-blue-500"></div>
                    </div>
                  </div>
                </div>
                <button type="submit" id="submitBtn" disabled class="w-full mt-6 bg-black text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-800 transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">Process Attendance Sheet</button>
              </form>
            </div>
          </div>
        </div>
        <!-- Footer -->
        <div class="text-center mt-12 text-gray-400 text-sm">
          <p>Powered by TensorFlow & Flask | Â© 2026 Attendance AI</p>
        </div>
      </div>
    </div>
    
    <!-- Corner Camera Button -->
    <button id="openCameraModalBtn" class="fixed bottom-8 right-8 bg-black text-white h-16 w-16 rounded-full shadow-lg flex items-center justify-center hover:bg-gray-800 transition-all">
      <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path>
      </svg>
    </button>
    
    <!-- Camera Confirmation Modal -->
    <div id="cameraModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm text-center">
            <h3 class="text-2xl font-bold mb-4">Scan with Camera?</h3>
            <p class="text-gray-600 mb-6">This will open a fullscreen view to scan your document using your device's camera.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelScanBtn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition">Cancel</button>
                <button id="confirmScanBtn" class="px-6 py-2 rounded-lg bg-black text-white hover:bg-gray-800 transition">Scan Now</button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Camera Overlay -->
    <div id="fullscreenCameraOverlay" class="fixed inset-0 bg-black z-50 flex-col items-center justify-center hidden">
      <video id="cameraFeed" class="w-full h-full object-contain" playsinline autoplay muted></video>
      <canvas id="cameraCanvas" class="hidden"></canvas>
      <div id="cameraMessage" class="absolute text-white text-center p-4 bg-black/50 rounded-lg">
        <p>Camera is off. Click the play button to begin.</p>
      </div>
      <div id="cameraSpinner" class="absolute inset-0 flex items-center justify-center bg-black/50 hidden">
        <svg class="w-16 h-16 text-white animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
      </div>
      <div id="cameraControls" class="absolute bottom-8 flex space-x-4 p-2 bg-black/30 backdrop-blur-sm rounded-full">
        <button id="startCameraBtn" class="bg-blue-600 text-white font-bold h-16 w-16 rounded-full hover:bg-blue-700 transition flex items-center justify-center">
            <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
        </button>
        <button id="captureBtn" class="bg-white h-16 w-16 rounded-full hidden items-center justify-center"></button>
        <button id="stopCameraBtn" class="bg-red-600 text-white font-bold h-16 w-16 rounded-full hover:bg-red-700 transition flex items-center justify-center">
             <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    </div>

    <script>
      // DOM Elements
      const mainContentWrapper = document.getElementById("mainContentWrapper");
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const uploadContent = document.getElementById("uploadContent");
      const imagePreviewContainer = document.getElementById("imagePreviewContainer");
      const imagePreview = document.getElementById("imagePreview");
      const scanner = document.getElementById("scanner");
      const submitBtn = document.getElementById("submitBtn");
      const uploadForm = document.getElementById("uploadForm");
      
      const cameraModal = document.getElementById("cameraModal");
      const openCameraModalBtn = document.getElementById("openCameraModalBtn");
      const confirmScanBtn = document.getElementById("confirmScanBtn");
      const cancelScanBtn = document.getElementById("cancelScanBtn");

      const fullscreenCameraOverlay = document.getElementById("fullscreenCameraOverlay");
      const startCameraBtn = document.getElementById("startCameraBtn");
      const stopCameraBtn = document.getElementById("stopCameraBtn");
      const captureBtn = document.getElementById("captureBtn");
      const cameraFeed = document.getElementById("cameraFeed");
      const cameraCanvas = document.getElementById("cameraCanvas");
      const cameraMessage = document.getElementById("cameraMessage");
      const cameraSpinner = document.getElementById("cameraSpinner");
      let stream = null;

      // --- Upload Logic ---
      function handleFileSelect(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
          imagePreview.src = e.target.result;
          uploadContent.classList.add("hidden");
          imagePreviewContainer.classList.remove("hidden");
          submitBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      }

      uploadArea.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", () => handleFileSelect(fileInput.files[0]));
      uploadArea.addEventListener("dragover", (e) => { e.preventDefault(); uploadArea.classList.add("border-black"); });
      uploadArea.addEventListener("dragleave", () => uploadArea.classList.remove("border-black"));
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.classList.remove("border-black");
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(fileInput.files[0]);
      });

      uploadForm.addEventListener("submit", (e) => {
        e.preventDefault();
        scanner.classList.remove("hidden");
        submitBtn.disabled = true;
        submitBtn.textContent = "Processing...";

        const formData = new FormData(uploadForm);
        fetch("/", { method: "POST", body: formData })
        .then(response => {
             if (response.redirected || response.headers.get('Content-Type').includes('text/html')) {
                window.location.href = response.url;
             } else if (response.ok && response.headers.get('Content-Disposition')) {
                response.blob().then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    const filename = response.headers.get('Content-Disposition').split('filename=')[1].split(';')[0].replace(/"/g, '');
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    setTimeout(() => window.location.reload(), 1000); 
                });
             }
        })
        .catch(error => {
            console.error("Error submitting form:", error);
            window.location.reload();
        });
      });

      // --- Camera Modal Logic ---
      openCameraModalBtn.addEventListener("click", () => cameraModal.classList.remove("hidden"));
      cancelScanBtn.addEventListener("click", () => cameraModal.classList.add("hidden"));
      cameraModal.addEventListener("click", (e) => {
          if (e.target === cameraModal) {
            cameraModal.classList.add("hidden");
          }
      });
      confirmScanBtn.addEventListener("click", () => {
          cameraModal.classList.add("hidden");
          mainContentWrapper.classList.add("hidden");
          fullscreenCameraOverlay.classList.remove("hidden");
          fullscreenCameraOverlay.classList.add("flex");
          stopCameraBtn.classList.remove("hidden");
          startCameraBtn.classList.remove("hidden");
          captureBtn.classList.add("hidden");
      });

      // --- Fullscreen Camera Logic ---
      function stopCamera() {
          if (stream) {
              stream.getTracks().forEach(track => track.stop());
          }
          stream = null;
          cameraMessage.classList.remove("hidden");
          cameraFeed.classList.add("hidden");
          startCameraBtn.classList.remove("hidden");
          captureBtn.classList.add("hidden");
          stopCameraBtn.classList.add("hidden");

          fullscreenCameraOverlay.classList.add("hidden");
          fullscreenCameraOverlay.classList.remove("flex");
          mainContentWrapper.classList.remove("hidden");
      }
      stopCameraBtn.addEventListener("click", stopCamera);

      startCameraBtn.addEventListener("click", async () => {
        if (!navigator.mediaDevices?.getUserMedia) {
          cameraMessage.innerHTML = '<p class="text-red-400">Camera not supported.</p>';
          return;
        }
        try {
          stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
          cameraFeed.srcObject = stream;
          cameraFeed.onloadedmetadata = () => {
            cameraFeed.play();
            cameraFeed.classList.remove("hidden");
            cameraMessage.classList.add("hidden");
            startCameraBtn.classList.add("hidden");
            captureBtn.classList.remove("hidden");
            captureBtn.classList.add("flex");
            stopCameraBtn.classList.remove("hidden");
          };
        } catch (err) {
          cameraMessage.innerHTML = `<p class="text-red-400">Camera access denied. Please allow camera permissions.</p>`;
        }
      });

      captureBtn.addEventListener("click", () => {
        if (!stream) return;
        cameraSpinner.classList.remove("hidden");
        captureBtn.disabled = true;

        cameraCanvas.width = cameraFeed.videoWidth;
        cameraCanvas.height = cameraFeed.videoHeight;
        const context = cameraCanvas.getContext("2d");
        context.drawImage(cameraFeed, 0, 0, cameraCanvas.width, cameraCanvas.height);
        
        stopCamera();

        cameraCanvas.toBlob((blob) => {
          const formData = new FormData();
          const fileName = `capture_${Date.now()}.jpg`;
          formData.append("file", blob, fileName);

          const dt = new DataTransfer();
          dt.items.add(new File([blob], fileName));
          fileInput.files = dt.files;
          handleFileSelect(fileInput.files[0]);

          uploadForm.dispatchEvent(new Event('submit', { cancelable: true }));

        }, "image/jpeg", 0.9);
      });
    </script>
  </body>
</html>